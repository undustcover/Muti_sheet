# 待办事项

更新日期：2025-10-28
版本：v0.0.4

> 目的：集中管理前端待开发功能，明确代码落点、功能说明、与前端接口（组件/状态/类型），并制定统一的写入标准与验收准则。

---

## 待开发功能列表

### UI-001 HeaderMenu 功能补齐
- 功能说明：补齐表头菜单的全部动作（编辑字段、编辑描述、整列填色、复制字段、隐藏字段、插入左/右、冻结至此字段、升序/降序、删除字段），并与列元数据 `columnMeta` 与可见性 `columnVisibility` 同步。
- 代码位置：
  - 组件：`apps/web/src/components/HeaderMenu.tsx`
  - 集成：`apps/web/src/App.tsx`（传递与处理各项回调）
  - 类型：`apps/web/src/types/table.ts`（建议新增，定义字段/列元数据）
- 与前端接口：
  - Props（建议统一）：
    ```ts
    type HeaderMenuProps = {
      columnId: string;
      index: number;
      disabled?: boolean;
      disableHide?: boolean;
      disableDelete?: boolean;
      onFreezeTo: (count: number) => void;
      onHideField: (id: string) => void;
      onShowHidden?: () => void;
      onInsertLeft: (id: string) => void;
      onInsertRight: (id: string) => void;
      onDuplicateField: (id: string) => void;
      onDeleteField: (id: string) => void;
      onSort: (dir: 'asc' | 'desc' | null) => void;
      onEditField: (id: string, patch: { name?: string; type?: string }) => void;
    }
    ```
  - 关联类型：
    ```ts
    type ColumnMeta = { name: string; type: 'text' | 'number' | 'date' | 'single' | 'multi' | 'user' | 'attachment' | 'formula' | 'creator' | 'modifier' | 'created_at' | 'updated_at' }
    type ColumnVisibility = Record<string, boolean | undefined> // false 表示隐藏
    ```
- 验收（DoD）：表头每列均可打开菜单并执行上述动作；冻结/隐藏/排序与渲染同步；控制台/终端无错误；最小单测覆盖。

### UI-002 条件引擎（筛选/填色）
- 功能说明：实现条件构建器组件与规则应用，支持筛选与填色（作用域：单元格/整行/整列），与排序互不冲突。
- 代码位置：
  - 组件：`apps/web/src/components/ConditionBuilder.tsx`（新增）
  - 状态：`apps/web/src/stores/colorRules.ts`（新增），`apps/web/src/stores/filterRules.ts`（新增）
  - 集成入口：`apps/web/src/components/Toolbar.tsx` 的 `onFilterOpen`/`onColorOpen`
- 与前端接口：
  - 条件类型：
    ```ts
    type Scope = 'cell' | 'row' | 'column'
    type Operator = 'eq' | 'neq' | 'contains' | 'not_contains' | 'gt' | 'lt' | 'between' | 'empty' | 'not_empty'
    type Condition = { id: string; fieldId: string; operator: Operator; value?: any; scope: Scope }
    type ConditionSet = { logic: 'and' | 'or'; items: Condition[] }
    ```
  - 组件Props：
    ```ts
    type ConditionBuilderProps = {
      fields: { id: string; name: string; type: string }[];
      value: ConditionSet;
      onSave: (next: ConditionSet) => void;
      onCancel: () => void;
    }
    ```
- 验收（DoD）：添加/编辑/删除规则即时生效；虚拟滚动帧率正常；与排序互不冲突；有基础单测与1条E2E。

### UI-003 视觉令牌与风格统一
- 功能说明：引入设计令牌（CSS变量），统一颜色、圆角、阴影、间距、字体，并应用到 `Sidebar/Tabs/Toolbar/Drawer` 等组件。
- 代码位置：
  - 样式：`apps/web/src/styles/tokens.css`（新增）
  - 应用：在主要组件文件内引入变量并替换内联样式关键值
- 与前端接口：
  - CSS变量：
    ```css
    :root {
      --color-primary: #1f5fff;
      --radius: 8px;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --spacing: 8px;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
    }
    ```
- 验收（DoD）：整页视觉一致、轻量动效自然、无布局抖动；影响组件均替换为令牌。

### UI-004 模块占位增强（收集表/仪表盘/文档/文件夹）
- 功能说明：在侧边栏入口切换时，确保各模块页面有基础占位与说明文案，后续按MVP逐步完善。
- 代码位置：
  - 页面：`apps/web/src/pages/Collect.tsx`、`apps/web/src/pages/Dashboard.tsx`、`apps/web/src/pages/Docs.tsx`、`apps/web/src/pages/Files.tsx`（新增）
  - 集成：`apps/web/src/App.tsx` 根据 `activeNav` 渲染页面
- 与前端接口：
  - 导航Key：`'collect' | 'dashboard' | 'docs' | 'files'`（来自 `Sidebar` 的 `onNavigate`）
  - 占位内容：各页面默认 `h3+说明段落`，后续替换为真实内容
- 验收（DoD）：切换各模块不报错，页面有合理占位与后续扩展位。

### QA-005 测试覆盖与管线
- 功能说明：完善单元/组件测试与E2E，建立基础覆盖率阈值与运行脚本。
- 代码位置：
  - 单元/组件：`apps/web/src/**/*.test.tsx`
  - E2E：`apps/web/tests/e2e/**/*.spec.ts`
  - 配置：`apps/web/vite.config.ts`（Vitest）、`apps/web/playwright.config.ts`（E2E）
- 与前端接口：
  - 脚本：`pnpm run test` / `pnpm run test:coverage` / `pnpm run test:e2e`
  - 阈值：单元/组件≥80%，E2E≥70%（后续在Vitest配置或CI中固化）
- 验收（DoD）：脚本顺畅运行，主路径用例通过，覆盖率达标并输出报告。

---

## 写入标准（统一要求）

- 结构与文档
  - 每个功能必须在本文件新增条目（ID/名称/说明/代码位置/接口/DoD/测试范围/风险与缓解）。
  - 变更需同步更新：`前端UItodolist.md` 与相关需求文档（如有影响）。
- 类型与约束
  - 所有新增数据结构必须以 TypeScript 类型定义，集中于 `apps/web/src/types` 或组件本地类型。
  - 明确不可变约束（如首列不可删除），在组件 Props 与实现中显式体现。
- 代码规范
  - 使用函数式组件与 Hooks；避免在渲染周期内创建重型对象/监听器。
  - 严格 TypeScript（`strict`）、通过 ESLint；不引入未使用代码。
- 测试与验收
  - 新功能需同时提供最小单测（RTL+Vitest）与主路径 E2E（Playwright）。
  - DoD 写清：交互正确、无控制台/终端错误、性能无明显回退。
- 提交流程
  - 提交信息遵循：`feat: ...` / `fix: ...` / `chore: ...`；必要时在 PR/变更日志中列出影响面。
- 兼容与回滚
  - 对现有状态与接口的破坏性改动需在文档中标注，并提供迁移路径或回滚方案。

---

## 今日计划（示例，可每日更新）
- UI-001：补齐 HeaderMenu 的插入左/右、复制、删除；完善 `onEditField`
- UI-002：搭建 `ConditionBuilder` 初版，先实现 `eq/contains/empty` 三类规则；与 ColorRules 联动
- QA-005：E2E 稳定性增强（app-ready 标记与加载等待）；补充 `Sidebar/Tabs` 组件测试

## 备注
- 预览地址：`http://localhost:5173` / `http://localhost:5174`
- 相关文件：`前端UItodolist.md`、`开发需求方案.md`、`测试方案.md`

## 更新规则（新增）
- 不删减已有内容；仅新增进度与“进度更新”条目。
- 版本号递增（如 v0.0.x），每次更新需追加日期（ISO或YYYY-MM-DD）。
- 已完成的事项以 HTML 注释方式标记，示例：`<!-- UI-00X ... 已完成 -->`；系统下次解析将跳过，但内容保留以便后期总结。
- 影响到的实现/接口需在“进度更新”中明确文件路径与方法名，便于追踪。

## 进度更新（v0.0.4｜2025-10-28）
- 完成：颜色规则抽屉新增搜索过滤（按“字段名/条件摘要”筛选），虚拟滚动绑定筛选后的列表长度；UI 增加搜索输入与匹配统计（文件：`apps/web/src/components/ColorRulesDrawer.tsx`）。
- E2E：在 `tests/e2e/color-rules.spec.ts` 增加过滤用例，并清理严格模式下的文本歧义与残留 diff 标记造成的语法错误；曾全部通过，但当前存在加载时序偶发失败，后续拟引入 `data-app-ready` 标记与适当等待提升稳定性。
- 预览确认：`http://localhost:5173/` 可正常交互；抽屉内“条件摘要”与“规则搜索”表现正确。
- 状态增强：在 `apps/web/src/stores/colorRules.ts` 新增 `duplicateRule` 与 `setAllEnabled`（复制规则与批量启用/禁用）。
- 抽屉增强（`apps/web/src/components/ColorRulesDrawer.tsx`）：
  - 展示字段名称、每条规则新增“复制”按钮与“全部启用/禁用”批量操作。
  - 集成筛选条件构建器，仅在“单元格”作用域显示筛选条件入口；修复 `condOpen` 引用错误并放置在组件返回树中。
  - 调整整列填色逻辑：设置条件时仅对命中结果着色；无条件时整列基础色生效。
  - 规则列表支持虚拟滚动（`@tanstack/react-virtual`），避免列表溢出页面。
- 集成与过滤：在 `apps/web/src/App.tsx` 中通过 `columnVisibility` 过滤列传入 ColorRulesDrawer，使字段下拉仅显示可见列。
- 预览验证：`http://localhost:5175/` 无浏览器错误；建议终端复核是否存在新错误。

<!-- 本次进度无完全完成的功能条目，暂不对 UI-001/UI-002/UI-003/UI-004/QA-005 进行注释处理。 -->
## 最新

1. <!--注册页面与后台需要开发-->（2025.11.2）

2. <!--主页与多维表格页面要分开-->

   2. <!--主页-->

   <!--2.1 主页分为侧边栏和主列表。侧边栏采用树状结构，从上到下是都是一级层次，主页，我的空间，项目空间，文件夹。-->

   <!--2.2 主页点击后列表显示最近编辑过的数据表列表。-->

   <!--2.3 我的空间有三级目录，一级是项目，二级是任务，三级是数据表。点击一级项目，列表显示所有项目内的数据表，点击任务，里表显示所有任务内的数据表，点击数据表，直接进入多维表格。权限为所有由登录用户建立的数据表。-->

   <!--2.4 项目空间有三级目录，一级是项目，二级是任务，三级是具体数据表格。点击一级项目，列表显示所有项目内的数据表，点击任务，里表显示所有任务内的数据表，点击数据表，直接进入多维表格。权限为所有视图设置为公共视图的数据表。-->（2025.11.2）

   3. <!--管理员权限管理页面。-->（2025.11.2）

   <!--以上页面都需要结合后台和数据库进行开发-->

3. 删除项目创建、任务创建、这些无意义影响用户视觉效果的测试性文字

4. <!--删除有未分类任务的项目-->（2025.11.2）

5. <!--数据表依然无法写入，依然报错。-->（2025.11.2）

6. 修改保存逻辑，是在退出编辑状态之后进行保存，而不是增加内容后立即保存。

7. > [!NOTE]
   >
   > 修改删除逻辑，目前项目、任务、表格的删除虽然进行了二次提醒，但是是先删除了内容再进行的提醒，应该等用户二次确认完了之后再删除项目、任务与表格。（暂缓）

8. src\app.tsx瘦身

9. 新建用户应该为editor，而不是viewer

10. <!--excel的上传与下载的问题，导入的excel应该是创建一个无行无字段的表格，然后识别excel中的字段与行，再新建相同的行与字段（包括字段类型自动识别），最后在单元格中写入数据。一定要注意新建字段的类型和字段名称与excel表格保持一致。字段类型自动识别数字、文本、与日期，无法识别的字段一律新建为文本。-->（2025.11.2）

    > [!NOTE]
    >
    > 对表头有要求，不能合并表头，不能有二级表头

11. 粘贴功能新建的字段没有名称，类型也无法自动识别

12. 视图数据要持久化保存到后端

13. 删除之前的修改“我将为接口封装添加返回体规范化与缺失 ID 的调试日志，确保前端不再因不同返回结构触发 TypeError，并便于你定位后端响应。”，excel导入成功之后。

14. > [!WARNING]
    >
    > 权限系统更新：在数据表工具栏尾部新增文档权限管理的图标，鼠标移动到图标上显示文档权限管理，点击后弹出文档权限管理弹窗。
    > 9.1 文档权限管理内容为分为，1. 是否可以匿名查看文档；2.添加协作者。
    > 9.2 添加协作者之后可以为协作者设置权限，具体权限分文1. 可管理（可以编辑、分享内容和修改权限）；2.可编辑；3可阅读
    > 9.3 同步更新后台权限系统







## 后期代办

**现代化高级的看板**

尽快了解看板用途，利用后端数据设计看板展示模板，看板要高级，现代化。

4. 优化登录页面，左边是登录与注册的组件，右边是关于项目介绍的内容。参考nocoDB的登录页面
5. 仪表盘功能，仿照飞书开发仪表盘功能，测评开发仪表盘功能的难度









## 前端

2025.10.28

1. 首字段优化，默认为数字，可以更改类型，只能是文字、数字、日期、公式四种类型。
   1.1 首字段默认冻结，在滑动下方左右滑块时，字段不动（完成 2025.10.29）

2. 冻结字段功能没有实际效果，依然不是被冻结的情况。（完成2025.10.29）
3. 开发粘贴复制快捷键功能（ctrl+c  ctrl+v）（已完成2025.10.29）
4. 表头拖拽排序（不包括首字段）（已完成2025.10.29）
5. excel导入功能不可用。
6. 启动后端开发
7. 删除表头点击自动排序功能，排序只能在表头菜单中选择进行。（已完成2025.10.29）
8. 优化虚拟滑块，在页面显示不完整的情况没有虚拟滑块，只有最大化页面才出现虚拟滑块，调整虚拟滑块会自动判断页面缩小放大情况，然后在实际页面大小边缘出现（已完成2025.10.29）
9. 加入表格快捷键和基本操作（撤销、重做、查询、删除）（已完成2025.10.29）
10. 菜单工具栏在文字前加入图标（已完成2025.10.29）
11. 继续优化工具栏
    1. 将撤销、重做、查询、删除、导入excel、导出excel、显示隐藏字段放在最右侧，只显示图标，当鼠标放在图标上时显示功能名字。
    2. 其余工具栏放在左侧，横向显示字体，略微缩小字体，使工具栏更美观。
    3. 所有工具栏图标不使用彩色，使用浅灰色，使其更美观现代
12. 调整删除功能，只删除单元格里面的内容，不是删除单元格或行。（已完成2025.10.29）
13. 无法复制数字、日期，根据之前的需求，可以复制数字、日期、文本（已完成2025.10.29）
14. 替换侧边栏最底部灰色文本<仿飞书 · UI原型>为<HugoXu · 技术支持>（已完成2025.10.29）
15. scr\components\editors\DataTable.tsx近1000行了，是否需要拆分功能。（已完成2025.10.30）
16. scr\App.tsx又变大了，是否需要拆分功能。（已完成2025.10.30）
17. 在表格中加入右键点击功能，可以一次插入多行，并且可以选择在上方插入还是在下方插入（已完成2025.10.30）
18. 视图功能无法保存填色效果（已完成2025.10.30）
19. 筛选看不到已应用的筛选功能，无法对其进删除（已完成2025.10.30）
20. 首字段不可移动。
21. 填色功能，当填色过多时，弹出框显示不全，无法查看所有填色项（已完成2025.10.30）
22. 行高功能不可用.
23. 如果你希望，我可以：

    - 增加删除记录/批量删除的实现（目前按钮提示“暂未实现”）
    - 将视图数据持久化到本地存储或模拟后端
    - 增加 TopBar 视图的排序/拖拽
    - 补充更多快捷键（如切换视图、切换冻结列等）
24. 进行前端e2e测试（完成2025.10.31）

24.对界面进行配色调整，依然保持简约纯色风格，背景主色调还是白色，但是需要更现代，更大气（已完成2025.10.31）

25. 修改导入功能，导入先要提示用户确认导入excel表格，然后分析表格的格式，行与列，在该项目、该任务下新建一个表格来适配导入表格，将导入表格的数据全部传输到该表格，新建表格名字与导入excel表格名字一致。（已完成2025.10.30）
26. 表头下拉菜单中



## 后端及数据库

### 后端及数据库开发原则
现在开始系统的后端及数据库建设了。

1. 后端及数据库建设基于现在前端实现的功能，将前端数据的存储、计算、筛选、聚合整合到后端。
2. 目的是为了对前端各个项目，各个任务，各个数据表的数据进行存储，长期保存，以及后期对于相关数据的增删改查、数据分析等功能。
3. 拟定后端与数据库开放所需的所有内容，形成<后端与数据库设计方案.md>,<后端与数据库开发方案.md>，<后端与数据库开发实施细节todolist.md>。
4. 后端与数据库开发要使用模块化开发，单个文件的功能不要太复杂，要便于阅读与修改，在后期修改需求时仅对某个模块产生影响，而不会影响到整体系统。
5. 最终利用AIcoding对后端与数据库进行开发，所以要在<后端与数据库开发实施细节todolist.md>里面定义所有开发节点，测试环境，代码约定。
6. <重要>一定要在文档中明确，在开发过程中若遇到不清楚的地方，一定要要求用户澄清，禁止随便增加功能。

###  澄清事项

需澄清事项

- 技术栈偏好：是否接受 Node.js + NestJS + PostgreSQL + Prisma ？如已有后端栈要求请说明。确认使用技术栈偏好
- 多租户模型：是否需要组织/团队隔离？是否允许跨项目联表查询？没有多租户模式

- 权限范围：是否需要字段级权限？视图是否可共享给不同角色？需要字段集权限，视图可以共享给不同角色，但是需要进行权限管理。
- 查询 DSL：是否需要支持前端现有筛选表达式的完整映射（例如高级 like 、 regex ）？是的，需要
- 分组与聚合：分组的显示逻辑与聚合口径（空值处理、去重规则）需确认。与目前前端分组与聚合的模式一致
- 公式引擎：表达式语言选择（Excel 风格/JS 风格），是否需要跨表引用？表达式用Excel风格，不需要跨表引用，预留结构，以后进行迭代。
- 日期与时区：统一使用 UTC 吗？显示与存储的规则（ YYYY-MM-DD 与 datetime ）。使用中国统一UTC，显示为YYYY-MM-DD，存储规则 datetime 
- 撤销重做作用域：以用户会话为作用域还是以视图为作用域？是否需要跨会话撤销？已视图作为作用域，不需要跨会话撤销
- 导入映射：Excel 列到字段的自动匹配规则、冲突处理（新增列/拒绝导入）。目前的导入模式是新建表进行导入，全部是新增列，不支持原表导入，所有导入都是新建数据表。
- 附件存储：是否使用对象存储（如 S3）？是否需要防病毒扫描与配额限制？附件存储在服务器计算机文档中，需要防病毒扫描，单个附件不超过20MB，总体附件存储空间不超过50GB
- 审计与合规：日志保留时长与可访问范围；是否需要导出审计报告。日志保留时长为120天，不需要导出审计报告
- 性能预期：表规模、记录数级别、并发编辑场景的目标指标。表规模不超过100列，1000行，单个单元格不会超过1000个汉字，同时编辑人数不超过10人。
- 需要权限管理与用户个人界面，需要登录后才能对数据表进行编辑。
- 需要管理员后台对用户进行管理。



- 字段级权限默认策略：未显式配置时是否默认 viewer=只读、editor=可写 ？是否支持字段“隐藏不可见”和“只读可见”两种状态？未显式配置时默认 viewer=只读、editor=可写,支持字段“隐藏不可见”和“只读可见”两种状态
- 视图共享范围与方式：是否支持按用户精确共享？共享视图是否允许导出（例如 viewer 是否能导出）？支持按用户精确共享，同时提供匿名只读共享（需要对表权限进行设定），共享视图是允许导出（默认不能导出，当表编辑者开启可导出权限时，才能导出）
- 查询 DSL 本地化与大小写： like/regex 是否区分大小写？中文排序与匹配是否需要本地化（拼音/笔画）？ like/regex 不区分大小写，中文排序与匹配需要本地化，按拼音
- 日期存储与显示：是否明确采用“UTC 标准存储 + 显示转 Asia/Shanghai (UTC+8) ”？若需本地时区存储，需要统一数据库类型与转换策略。明确采用“UTC 标准存储 + 显示转 Asia/Shanghai (UTC+8)
- 导入 Excel 细节：首行是否固定为表头？是否启用类型自动推断与严格校验（出错行如何处理——跳过/停止/标记）？首行固定为表头，启用类型自动推断，只对文本、数字、日期进行分类，当无法确定类型时，全部按照文本导入。
- 防病毒扫描策略：使用哪种扫描引擎（Windows Defender/ClamAV）？扫描失败的文件是拒绝并删除，还是隔离保留？是否需要病毒日志与告警？使用Windows Defender扫描引擎，扫描失败是拒绝并删除，同时警告用户
- 管理员后台职责：是否包含用户锁定、密码重置、角色分配、审计日志查看与下载？是否需要简单仪表盘统计？包含用户锁定、密码重置、角色分配、审计日志查看与下载，需要简单仪表盘统计。
- 并发编辑是否开启“单元格编辑锁”：若开启，锁超时和解除策略是什么？需要开启
- 锁超时
  - 默认**120 s**。
  - 加锁请求里带 expire／ttl 字段，后端直接写入 Redis 或同类缓存，利用 **EX／PX 参数原子过期**，即使客户端崩溃也能自动释放。
- 续期（看门狗）
  - 客户端在获得锁后，每隔 **1/3～1/2 的超时周期**（如 30 s）发一次「extend」心跳；成功则把 ttl 重新灌满。
  - 续期请求必须带上**唯一 requestId／userId**，后端校验"是不是持锁者本人"才给续，防止串改。
  - 如果续期失败（网络断开、进程被杀），心跳停止，锁会在下一轮 ttl 到期时自动失效。
- 主动与被动解除
  - **主动**：用户离开单元格、切换工作表、关闭浏览器标签时，前端立即调用 unlock；后端删除 key 并广播「锁释放」事件，把单元格状态置为可编辑。
  - **被动**：ttl 到 0 后 Redis 自动删 key；或者后端定时巡检「已过期但 key 还在」的残留锁，强制清除并写审计日志。
  - **覆盖策略（可选）**：高权限用户或管理员可"强制解锁"，此时会给原持锁者推送提示，并记录操作人。

### 后端及数据库开发要点

#### 一、**前后端协作与接口规范**

1. **明确接口契约（API文档）**

   - 前后端需提前约定接口路径、请求方法（GET/POST等）、参数格式（如RESTful或GraphQL）、响应结构（统一JSON格式，包含状态码、数据、错误信息）。
- 使用工具如Swagger/OpenAPI生成文档，确保前后端同步更新。
2. **数据格式与字段校验**

   - 后端需严格校验前端传入的数据类型、长度、必填项，避免脏数据。
   - 前端已开发的表单需与后端校验规则保持一致。

------

#### 二、**数据库设计核心要求**

1. **与前端数据需求对齐**
   - 分析前端页面所需的数据结构，设计表时避免过度冗余或复杂关联。
2. **三大范式与反范式平衡**
   - 遵循第三范式（3NF）减少冗余，但对高频查询场景可反范式化。
3. **字段设计细节**
   - **时间字段**：统一用`DATETIME`或`TIMESTAMP`
   - **状态字段**：用`TINYINT`枚举并加`CHECK`约束。
   - **金额字段**：用`DECIMAL(10,2)`避免浮点精度问题。
4. **索引优化**
   - 为前端搜索功能对应的字段建索引，但避免过度索引（写操作多的表不超过5个索引）。
   - 联合索引需遵循“最左前缀”原则可优化`WHERE category_id=1 AND price<100`）。

------

#### 三、**后端开发关键注意点**

1. **分层架构与职责隔离**

   - 严格分层：Controller→Service→DAO，禁止跨层调用。
   - Service层需处理业务逻辑，DAO层仅负责CRUD。
2. **数据转换与DTO**

   - 避免直接返回数据库实体（Entity）给前端，需通过DTO过滤敏感字段。
3. **事务与并发控制**

   - 对涉及多表的操作使用事务，并设置合理的隔离级别。
   - 高并发场景用乐观锁。
4. **错误处理与日志**

   - 后端错误需返回统一格式，禁止堆栈信息泄露给前端。
   - 记录关键日志，用TraceID串联前后端请求。

#### 

------

#### 四、**部署与扩展性**

1. **环境一致性**
   - 数据库字符集统一为`utf8mb4`，后端配置分环境（dev/test/prod），通过Docker管理。
2. **API版本控制**
   - 接口URL需带版本号（如`/api/v1/user`），避免前端升级时破坏旧版本。
3. **数据库迁移工具**
   - 使用工具管理数据库变更，避免手动执行SQL导致环境差异。







## 后期开发功能



25. 仪表盘功能（了解有什么用，能做什么）
26. 看板功能（（了解有什么用，能做什么）
27. 甘特图功能



## AI提示后续优化

后续可选增强

- 增加更多函数模板（如 count 、 median 、 round ）。
- 对参与字段缺失或类型变化时提供健壮的提示与保护。
- 支持用户自定义格式模板（如货币符号、负数显示）。

在下拉项上支持单击选中、回车选择等快捷键。



## 代码重构

是否需要拆分

- 可以拆分，且强烈建议拆分。一个上千行的 src/App.tsx 已经超出“单文件负责单职责”的范围，拆分能显著提升可读性、维护性和功能演进速度。
- 目前只做前端也可以重构，不需要等待后端启动。只要现有对外接口（例如行数据结构、列定义、事件回调）保持不变，拆分不会影响系统运行。
对运行与性能的影响

- 性能基本不受影响。Vite/ESBuild 会对模块做打包、树摇和依赖合并；文件拆分不会增加运行时开销。
- 你的智能搜索（AI coding）不受负面影响，反而更好：模块化提高检索准确性（更短的文件、更明确的导出），能更快定位到具体逻辑。
推荐拆分结构

- src/components/DataTable.tsx ：表格渲染、 useReactTable 配置、虚拟滚动、排序/可见性对接。
- src/components/editors/CellEditor.tsx ：单元格编辑的入口，按类型分发到具体控件。
- src/components/editors/SingleSelectControl.tsx 、 MultiSelectControl.tsx 、 DatePickerControl.tsx ：各类型编辑器独立文件，保留你已实现的智能翻转、键盘导航、虚拟滚动。
- src/hooks/useTableState.ts ：封装当前的表级状态（ tables 映射、 activeTableId 、包装版 setData / setColumnMeta 等），提供清晰 API 给视图层。
- src/types.ts ：集中定义 RowRecord 、 SelectOption 、 FormulaConfig 、 NumberFormat 等类型。
- 现有组件保持不变： Sidebar 、 Toolbar 、 HeaderMenu 、 FieldDrawer 等继续使用；只是调整它们的 props 来源路径。
渐进式重构计划

- 第一步：提取 CellEditor 与各类型控件到 components/editors/ ，用现有 props 不改行为。App 内部把 renderDisplay / CellEditor 的引用替换为导入。
- 第二步：把表级状态封装为 useTableState ，在 App 中引入该 hook，替换原本的局部状态与包装 setter。
- 第三步：提取 DataTable ，将列构建、 useReactTable 、虚拟滚动和键盘导航移入，App 保留“页面框架”与“工具条/抽屉”等容器层。
- 每一步后都跑本地预览验证交互，不引入新功能，严格保证回归稳定。
实施注意点

- 保持对外数据结构不变： RowRecord 字段名、列 id 、 columnMeta 类型不可改动，否则会影响筛选/颜色规则/导出等逻辑。
- 避免循环依赖：编辑器组件只依赖类型和必要的 util，不直接依赖 App。
- 样式与定位：提取控件后仍用 createPortal + 智能翻转逻辑，避免因层级变化产生遮挡。
- 测试与选择器稳定：如果有测试，保证组件的 data-app-ready 、表头/单元格 key/id 保持一致，避免选择器失效。
何时进行

- 不必等后端。当前前端已经具备完整交互和状态，适合立即进行模块化重构。
- 如果后续需要接后端，只要 useTableState 的 API 稳定，替换数据源从本地 mock 到远端即可，模块化反而会让这一步更容易。
如果你希望，我可以按上述“三步走”直接开始拆分，并在每一步结束后打开预览验证不回归，最后以一次提交和 refactor: split App.tsx into modules 的信息记录重构。
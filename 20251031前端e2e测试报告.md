# 2025-10-31 前端 E2E 测试报告

## 概述
- 目标：梳理当前 Web 前端已有功能，执行端到端（E2E）测试，并输出测试结论与改进建议。
- 范围：基于现有 Playwright E2E 用例（`apps/web/tests/e2e`）覆盖的功能。
- 结论：本次执行的 2 项用例均失败（详见“测试结果”与“问题与建议”）。

## 测试环境
- 框架与工具：`Playwright @1.56.1`、`Vite @7.1.x`、`React @19.1.x`
- 运行命令：
  - 安装浏览器：`npm run e2e:install`
  - 运行 E2E：`npm run test:e2e -- --reporter=list`
- 服务器配置：`apps/web/playwright.config.ts`
  - `baseURL`: `http://localhost:5173`
  - `webServer`: `pnpm run dev`（`reuseExistingServer: true`，`timeout: 120_000`）
- 代码位置：`apps/web/tests/e2e/**/*.spec.ts`
- 结果产物：`apps/web/test-results/`

## 功能与用例
- Sidebar 原型标识展示
  - 说明：侧边栏应显示原型标识文本，用以确认起始页面加载与基本 UI 呈现。
  - 用例路径：`apps/web/tests/e2e/basic.spec.ts`
  - 关键步骤：
    - 访问首页 `/`。
    - 等待应用就绪标记：`[data-app-ready]`。
    - 断言文本：`仿飞书 · UI原型` 可见。
  - 预期结果：文本可见，用例通过。

- 填色规则抽屉（条件构建、复制/批量启用、虚拟列表）
  - 说明：打开“填色规则”抽屉，配置筛选条件，并验证列表搜索与虚拟滚动行为。
  - 用例路径：`apps/web/tests/e2e/color-rules.spec.ts`
  - 关键步骤：
    - 访问首页 `/`，等待 `[data-app-ready]`。
    - 点击工具栏按钮：`填色`。
    - 断言抽屉标题：`填色规则` 可见。
    - 设置作用域为“单元格”，字段选择“文本”，打开“筛选器”并设置值为 `A`，应用。
    - 再次打开抽屉，断言摘要 `含条件：` 与 `文本 包含 A` 可见。
    - 验证搜索过滤：输入关键字后，虚拟列表的可见项计数减少；清空搜索后恢复。
  - 预期结果：抽屉打开并可操作、摘要与搜索行为正确，用例通过。

## 测试结果
- 执行命令输出摘要：
  - `npm run test:e2e -- --reporter=list`
  - 结果：2 失败 / 0 通过
- 失败详情：
  1. `[chromium] › tests/e2e/basic.spec.ts:3:1 › sidebar displays prototype label`
     - 失败原因：`expect(page.getByText('仿飞书 · UI原型')).toBeVisible()` 超时。
     - 可能原因：页面未显示该文本；或 `data-app-ready` 标记未设置，初始延时不足。
     - 产物：`apps/web/test-results/basic-sidebar-displays-prototype-label-chromium/error-context.md`
  2. `[chromium] › tests/e2e/color-rules.spec.ts:6:1 › Color Rules drawer: condition, duplicate/batch, virtual list`
     - 失败原因：`expect(getByRole('heading', { name: '填色规则' })).toBeVisible()` 超时，未找到元素。
     - 可能原因：点击“填色”未打开抽屉（入口或标题文案变更）；或抽屉渲染依赖前置状态但 UI 流程变动。
     - 产物：无（标准输出仅包含错误栈）。

## 问题与建议
- 稳定性标记：
  - 建议在 `App` 根节点或页面就绪逻辑处统一设置 `data-app-ready` 属性，并确保初始数据与异步状态加载完成后再置位。
- 文案与选择器：
  - 确认侧边栏是否仍展示 `仿飞书 · UI原型` 文案；若已改版，更新 E2E 断言为新的稳定选择器（例如基于 `data-testid`）。
  - “填色规则”抽屉标题或触发入口如有改动，应同步更新 E2E 用例内的角色与文本匹配逻辑（优先考虑 `data-testid` 而非纯文本）。
- 交互流程依赖：
  - 若抽屉依赖当前视图/字段可见性等前置条件（如需先选定某视图或字段），应在用例中显式设置这些状态；或在组件内提供可测试的默认状态。
- 产物与可视化：
  - Playwright 默认 `trace: 'on-first-retry'`，但当前未触发重试；可改为 `trace: 'on'` 或在失败时保存快照/视频，便于问题定位。
- 进一步覆盖建议：
  - 视图 Tabs：新增/重命名/复制/删除；按表隔离与默认视图创建流程。
  - 表格交互：字段隐藏/排序/行高；编辑器输入与撤销重做；冻结列与隐显提示。
  - 导入导出：Excel 映射与错误提示；导入创建新表的流程验证。

## 执行记录
- 浏览器安装：`npm run e2e:install`（成功）
- 测试执行：`npm run test:e2e -- --reporter=list`（退出码 1，2 失败）
- 服务器：本地 `http://localhost:5173/` 可启动并访问（E2E在运行时会复用/拉起开发服务）。

## 结论
- 当前 E2E 用例反映出 UI 文案/流程与测试脚本存在不一致，导致 2 项功能未通过。
- 建议尽快对选择器策略与页面就绪标记进行统一，随后补充关键路径的 E2E 覆盖并启用可视化产物，以提升可回归性与问题定位效率。
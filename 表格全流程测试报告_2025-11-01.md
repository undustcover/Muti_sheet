# 表格全流程测试报告（2025-11-01）

## 概述
- 目标：执行“表格”相关的前端端到端（E2E）测试，梳理已覆盖的用例与功能，并输出结论与后续建议。
- 范围：基于 `apps/web/tests/e2e` 中与表格交互直接相关的用例（字段、表头菜单、网格编辑、工具栏）。

## 测试环境
- 前端：`Playwright @1.56.1`、`Vite @7.1.x`、`React @19.1.x`
- 运行命令：`pnpm -C apps/web test:e2e -- --reporter=list`
- Dev Server：`apps/web/playwright.config.ts` 指向 `http://localhost:5173`（`reuseExistingServer: true`）
- 后端：`apps/server start:dev`（NestJS + Prisma）
- 账号：测试脚本支持从环境变量读取 `ADMIN_EMAIL`、`ADMIN_PASSWORD`（默认 `admin@example.com`/`admin123`）

## 用例清单与功能覆盖
- 字段 CRUD（新增/重命名/类型切换/删除）
  - 用例：`apps/web/tests/e2e/field-crud.spec.ts`
  - 场景：
    - 登录并通过 API 创建项目/任务/表（`utils/auth.ts`、`utils/space.ts`）。
    - 进入 `/table/:tableId`，等待 `[data-app-ready="1"]`。
    - 工具栏“字段配置 ▾”→“新增字段”→`FieldDrawer` 填写“字段名/类型”→“保存”。
    - 工具栏“字段配置 ▾”→点击该字段“···”→重命名并保存。
    - 工具栏“字段配置 ▾”→编辑该字段“类型”为“数字”并保存。
    - 表头菜单“▾”→“删除字段”，断言字段移除。
  - 覆盖功能：字段创建与编辑入口、`FieldDrawer` 保存流程、类型切换约束、表头删除动作与 UI 更新。

- 表头菜单（隐藏/显示、排序、整列填色、编辑字段重命名）
  - 用例：`apps/web/tests/e2e/header-menu.spec.ts`
  - 场景：
    - 打开表头菜单“▾”，执行“隐藏字段”，通过 toast 中的“显示已隐藏字段”恢复。
    - 执行“升序/降序”，表头出现 `▲/▼` 指示。
    - 执行“整列填色”，验证单元格背景应用。
    - 执行“编辑字段”，通过弹窗重命名字段。
  - 覆盖功能：表头菜单各操作，隐藏/排序指示，列级填色反馈。

- 网格编辑（双击进入编辑、复制选区提示）
  - 用例：`apps/web/tests/e2e/grid-editing.spec.ts`
  - 场景：
    - 双击单元格进入编辑并保存文本值。
    - 复制选区显示复制提示（toast）。
  - 覆盖功能：网格单元格进入编辑、保存行为、复制反馈。

- 工具栏（行高、筛选抽屉、字段配置、显示隐藏字段）
  - 用例：`apps/web/tests/e2e/toolbar.spec.ts`
  - 场景：
    - “行高 ▾”下拉选择不同高度并应用。
    - 打开“筛选器”抽屉并关闭。
    - “字段配置 ▾”中使用“+ 新建”创建字段，并编辑字段内容。
    - 点击“显示隐藏字段”按钮恢复已隐藏列。
  - 覆盖功能：工具栏入口与交互、字段配置面板流程、列可见性控制。

## 执行与结果
- 执行命令：`pnpm -C apps/web test:e2e -- --reporter=list`
- 终端摘要：命令返回非零退出码（exit code 1），显示多项用例条目；具体失败详情在终端输出与 `apps/web/test-results/` 中的产物（若启用）。
- 可能原因与建议：
  - Dev Server 端口或地址与 `baseURL` 不一致时会导致元素未出现（确保 `5173` 可用且 UI 加载完成）。
  - 登录态或后端数据未准备（确保后台 `start:dev` 正常，`ADMIN_EMAIL/ADMIN_PASSWORD` 有效）。
  - 文案差异或选择器不稳定（已统一使用“字段配置 ▾”“▾”“保存”等稳定选择器，可根据 UI 调整）。

## 后续建议
- 如需更直观的失败明细，建议使用 `--reporter=html` 并打开 HTML 报告。
- 针对偶发加载时序问题：统一使用 `[data-app-ready="1"]` 做就绪判断，并在关键互动前增加断言等待。
- 若需验证后端字段持久化，补充 `apiListFields` 比对（当前前端字段操作多为本地状态更新）。

## 附录
- 相关配置：`apps/web/playwright.config.ts`
- 相关组件：`HeaderMenu.tsx`、`FieldDrawer.tsx`、`Toolbar.tsx`、`GridSurface/index.tsx`、`DataTable.tsx`
- 相关服务：`projects.ts`、`tasks.ts`、`tables.ts`、`fields.ts`
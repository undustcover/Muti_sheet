# 开发需求方案

## 目标与范围
- 目标：构建仿飞书的多维表格系统，MVP聚焦表格视图与基础协同。
- 范围：
  - 侧边栏：项目/任务/数据表层级、分割线、收集表、仪表盘、文档、文件夹。
  - 数据表：网格视图（≤10个标签页）、视图操作（重命名/复制/保护/删除）、工具栏（添加记录/字段配置/筛选/分组/排序/行高/填色/分享/撤销/重做/查询/评论）、表头菜单、内容编辑与约束、Excel导入/导出。
  - 协同：多人编辑、光标、评论（逐步演进，先乐观更新后CRDT/OT）。

## 架构与技术栈
- 前端：React + TypeScript + Vite；状态 `zustand`；表格 `@tanstack/react-table + react-virtual`；拖拽 `dnd-kit`；Mock `MSW`；日期 `dayjs`；Excel `xlsx`。
- 后端：Node.js + Express + TypeScript；ORM `Prisma`；WebSocket；鉴权：账号密码；配置 `.env`。
- 数据库：PostgreSQL；记录值主存 `JSONB`；全文检索与索引（GIN/BTREE，pg_trgm）。
- CI/CD：GitHub Actions；测试：Vitest/Playwright/Supertest/nock/testcontainers/pgBench；Lint/Prettier。

## 详细功能需求
- 侧边栏
  - 项目→任务→数据表层级导航；支持分割线；入口：收集表、仪表盘、文档、文件夹（MVP提供静态占位与基础创建/浏览）。
- 数据表顶部
  - 标签页管理≤10；标签页右侧“···”菜单：重命名、复制视图、保护视图、删除视图。
  - 保护视图抽屉：公共（协作者可改）、锁定（不可改）、个人（仅自己可见）；抽屉悬停可见、移出隐藏。
  - “+”新建视图。
- 表格工具栏
  - 添加记录、字段配置（表头列表+三点抽屉：编辑/删除，编辑弹窗：标题input+类型+右侧类型选项）、筛选（条件构建器）、分组、排序、行高（低/中/高/超高）、填色（条件着色，24色，作用域：单元格/整行/整列）、分享、撤销、重做、查询、评论。
- 网格表格
  - 字段类型：文本、单选、多选、人员、数字、日期、附件、公式、创建人、修改人、创建时间、最后修改时间。
  - 表头下拉菜单：改字段、描述、整列填色、复制、隐藏、分割线、左右插入、冻结至此、分割线、正序/倒序、分割线、删除。
  - 约束：首列与表头不可删除；首列表头类型仅文本/日期/数字。
  - 编辑：直接网格编辑；粘贴批量；键盘操作；冻结列；拖拽列/行（按优先级渐进实现）。
- Excel导入/导出
  - 约定表头行映射；导出字段顺序与格式；导入校验与错误提示。

## 数据模型摘要（Prisma草案）
- bases, projects, tasks
- tables(id, base_id/project_id, name, desc)
- fields(id, table_id, type, options, order)
- records(id, table_id, values JSONB, version, created_by, updated_by, created_at, updated_at)
- views(id, table_id, type, config JSONB, protection, owner_id, shared)
- users(id, email, password_hash, name, role)
- permissions(table/view级)
- attachments(id, record_id, path, size, mime, checksum, created_by)
- comments(id, table_id/record_id, content, author, created_at)
- activities(id, actor, action, target, metadata, created_at)

## API概要（REST + WS）
- REST：
  - /auth/login, /auth/me
  - /projects, /tasks
  - /tables, /tables/:id/fields, /tables/:id/views
  - /tables/:id/records?filter[]=...&sort[]=...&page&size
  - /views/:id (GET/PUT/DELETE)
  - /attachments (POST上传/GET下载)
  - /share/:resource (生成/校验分享链接)
- WS：
  - 事件：record_created/updated/deleted, view_updated, cursor_moved, comment_added。

## 权限与认证
- 登录：账号密码；会话（JWT/Session）。
- 视图保护：公共/锁定/个人；共享链接只读；记录/视图级权限逐步实现。

## 非功能与指标
- 数据规模：≤1000行、≤100列；接口≤200ms P95；前端渲染平滑（虚拟滚动）。
- 安全：附件本地存储，单个≤20MB，总量≤100GB；类型校验与基础扫描；输入校验与审计日志。

## 完成定义（DoD）
- 需求对应UI可操作；API契约/类型对齐；单元/组件/集成/E2E测试通过；覆盖率达标；文档与变更记录齐备；CI绿。

## 风险与缓解
- 协同复杂→阶段化引入CRDT；
- 表格内核自研成本→采用成熟库组合；
- 服务端筛选复杂→统一条件表达式与索引策略；
- Excel导入差异→严格头部映射与校验反馈。
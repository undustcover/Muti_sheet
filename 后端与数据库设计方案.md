# 后端与数据库设计方案

## 概述
- 目标：将前端的数据存储、计算、筛选、分组、排序、导入导出与颜色规则等能力沉到后端，实现跨项目/任务/数据表的长期存储与标准化数据处理（CRUD、查询、聚合、审计）。
- 范围：单租户系统（不做多租户隔离），支持字段级权限与视图共享的权限管理；提供登录与管理员后台用户管理。
- 一致性：后端行为与当前前端模式一致（筛选、分组与聚合口径），前端交互不变，逐步迁移逻辑到后端。

## 技术栈
- 后端：Node.js + NestJS（或等价 Express 层）
- 数据库：PostgreSQL
- ORM：Prisma
- 缓存与队列：Redis（缓存、任务队列、发布订阅）
- 鉴权：JWT + RBAC（角色权限）

## 架构
- 服务划分：
  - tables-service：表与字段管理
  - records-service：行与单元格 CRUD、批量导入导出
  - query-service：筛选/排序/分组/聚合/分页（DSL）
  - formula-service：公式解析与计算（Excel 风格），增量重算与缓存
  - view-service：视图状态（列可见性/顺序、筛选/排序/分组、颜色规则）
  - audit-service：审计与历史、快照与撤销/重做（视图作用域）
  - files-service：附件上传与扫描（服务器文件系统）
  - auth-service：认证、授权、管理员后台（用户与角色）
- 实时协作：WebSocket/Socket.IO 推送表/视图/记录变更；并发编辑场景采用轻量冲突策略（见下）。

## 数据模型（关系型，简化）
- projects：`id, name, created_at`（单租户但保留项目维度）
- tables：`id, project_id, name, created_at, ...`
- fields：`id, table_id, name, type, options_json, order, visible, permission_json`
- records：`id, table_id, created_at, created_by`
- records_data（JSONB）：`record_id, table_id, data_jsonb, updated_at, updated_by`
  - 说明：`data_jsonb` 以 `field_id` 为 key 存储值，对热点字段建立表达式索引（GIN/BTREE）。
- views：`id, table_id, name, owner_user_id, shared_roles[], config_jsonb`
- color_rules：`id, table_id, config_jsonb`
- attachments：`id, table_id, record_id, path, meta_jsonb, size, created_at`
- audit_logs：`id, actor_user_id, table_id, record_id, action, payload_jsonb, created_at`
- users：`id, username, password_hash, roles[]`

## 权限模型与角色
- 角色：`owner, admin, editor, viewer`（可扩展）。
- 字段级权限默认：未显式配置时默认 `viewer=只读`、`editor=可写`；支持字段“隐藏不可见”和“只读可见”两种状态。
- 视图共享：支持按用户精确共享；同时提供匿名只读共享（需在表级开启该权限）。共享视图默认不可导出，仅当表编辑者开启“允许导出”权限后方可导出。
- 字段级权限：在 `fields.permission_json` 定义 `readRoles[]/writeRoles[]/hideRoles[]`、`readUsers[]/writeUsers[]` 等，支持按角色与用户覆盖。
- 导出权限：由视图/表权限控制，遵循上述共享策略与导出开关。

## 日期与时区策略
- 显示：`YYYY-MM-DD`（与前端保持一致）。
- 存储：`datetime`，统一采用 `UTC` 存储（数据库使用 `TIMESTAMP WITH TIME ZONE` 或统一标准化为 UTC），显示时按 `Asia/Shanghai (UTC+8)` 转换。
- 备注：若未来调整为本地时区存储，则在接口与数据库层保持一致转换策略。

## 查询 DSL（与前端一致）
- 过滤：`eq, neq, lt, gt, lte, gte, in, like, regex, between, exists`
- 排序：按字段升/降序；多字段排序
- 分组：按一个或多个字段分组；前端分组显示逻辑一致
- 聚合：`sum, avg, min, max, count`；按分组聚合或整体聚合
- 分页：`page, pageSize`
- 视图：`viewId` 可作为默认条件来源（列可见性/筛选/排序/分组）
- 大小写与本地化：`like/regex` 不区分大小写；中文排序与匹配要求按“拼音”本地化。
- 实现说明：使用 PostgreSQL 的 `ILIKE` 与 `~*`（不区分大小写正则），并为排序启用 ICU 拼音排序（如 `COLLATE "zh-u-co-pinyin"`）；若运行环境不支持拼音排序，将在应用层提供合理回退策略。

## 分组与聚合口径（与前端一致）
- 空值处理：空值分组显示为“空值”并参与统计；`count` 默认统计非空，`count_all` 统计全部（可选）。
- 去重规则：`distinct` 针对目标字段值去重，支持分组内去重与全局去重（默认分组内）。

## 公式引擎
- 表达式：Excel 风格（不跨表引用），保留结构以便后续扩展跨表。
- 存储：字段类型 `formula` + `formula_expr`；写入/编辑触发后端计算任务。
- 计算：增量重算（基于依赖图），结果缓存到 `records_data` 并标记更新时间。

## 导入/导出
- 导入：所有导入均创建新表；Excel 解析 → 映射列（首行固定为表头）到 `fields` → 类型自动推断（仅文本/数字/日期三类；无法确定类型时按“文本”导入）→ 事务写入。
- 导出：基于 `viewId` 的视图状态（筛选/排序/分组），按字段格式与颜色规则生成 Excel，流式下载。

## 附件存储与安全
- 存储：服务器本地文件系统，限制单附件 ≤ 20MB，总附件容量 ≤ 50GB。
- 防病毒：使用 Windows Defender 扫描引擎；扫描失败即拒绝并删除文件，同时警告用户并记录审计。
- 路径与访问：集中存储目录（如 `storage/attachments`），元数据记录在数据库，下载需权限校验。

## 审计与历史
- 审计：记录每次变更主体、前后值、来源（工具栏/快捷键/导入等），保留 120 天。
- 撤销/重做：以视图为作用域，不跨会话；前端本地历史即时响应，服务端记录标准历史并用于最终一致性。
- 管理员能力：管理员后台支持审计日志查看与下载，并提供基础仪表盘统计。

## 并发编辑与实时
- 冲突策略：同单元格最后写入覆盖（Last-Write-Wins），启用“单元格编辑锁”配置以降低冲突。
- 编辑锁（Redis）：默认 TTL **120s**，加锁请求包含 `expire/ttl`，后端使用 `EX/PX` 原子过期；客户端每隔 **1/3～1/2** 周期（如 **30s**）发送 `extend` 心跳续期。
- 续期校验：续期必须携带唯一 `requestId/userId`，后端校验持锁者身份后才续期；心跳停止时锁在 TTL 到期后自动释放。
- 解除锁：
  - 主动：用户离开单元格/切换表/关闭标签时调用 `unlock`，后端删除键并广播“锁释放”事件。
  - 被动：TTL 归零自动释放；后端定时巡检残留锁并强制清除，记录审计。
- 强制覆盖：高权限用户/管理员可强制解锁，向原持锁者推送提示，并记录操作者信息。

## 性能与扩展
- 规模：≤ 100 列、1000 行；单元格文本 ≤ 1000 汉字；并发编辑 ≤ 10 人。
- 索引：为高频筛选字段建立表达式索引；JSONB 使用 GIN；必要时物化视图。
- 批量与事务：导入与批量更新/删除采用事务与幂等设计；分页统一 `page/pageSize`，限制最大页大小。

## API 概览（REST）
- 表与字段：
  - `POST /api/projects/:projectId/tables`
  - `GET /api/projects/:projectId/tables`
  - `PATCH /api/tables/:tableId`
  - `POST /api/tables/:tableId/fields`
  - `PATCH /api/fields/:fieldId`
  - `DELETE /api/fields/:fieldId`
- 记录与单元格：
  - `POST /api/tables/:tableId/records`
  - `GET /api/tables/:tableId/records`
  - `PATCH /api/records/:recordId`
  - `DELETE /api/records/:recordId`
  - `POST /api/tables/:tableId/records:batch`
- 查询与聚合：
  - `POST /api/tables/:tableId/query`
  - `POST /api/tables/:tableId/aggregate`
- 视图与状态：
  - `POST /api/tables/:tableId/views`
  - `PATCH /api/views/:viewId`
  - `GET /api/tables/:tableId/views`
- 导入/导出与附件：
  - `POST /api/tables/:tableId/import`
  - `GET /api/tables/:tableId/export`
  - `POST /api/tables/:tableId/attachments`
- 历史与审计：
  - `GET /api/tables/:tableId/history`
  - `GET /api/records/:recordId/history`
  - `POST /api/history/undo`
  - `POST /api/history/redo`
- 认证与权限：
  - `POST /api/auth/login`、`POST /api/auth/logout`、`GET /api/users/me`
  - `GET/POST/PATCH /api/admin/users`（管理员后台）

## 已确认策略摘要
- 权限与共享：字段默认 `viewer=只读`、`editor=可写`；支持“隐藏不可见/只读可见”；视图支持按用户精确共享与匿名只读共享（需表级开启），共享视图默认不可导出，表编辑者可开启导出。
- 查询与本地化：`like/regex` 不区分大小写；中文排序/匹配按拼音本地化。
- 日期与时区：统一使用 `UTC` 存储，显示转换为 `Asia/Shanghai (UTC+8)`。
- 导入 Excel：首行固定为表头；类型自动推断（文本/数字/日期），无法确定类型时按文本导入。
- 防病毒：Windows Defender 扫描；失败即拒绝并删除并告警。
- 管理员后台：支持用户锁定、密码重置、角色分配、审计日志查看与下载；提供简单仪表盘统计。
- 并发编辑：启用单元格编辑锁，TTL 默认 120s，支持续期与强制解锁，记录审计。

## 下一步开发要点说明
- 初始化后端项目（`apps/server`）：NestJS + Prisma + PostgreSQL 连接与基础脚手架。
- 建模与迁移：`projects/tables/fields/records/records_data/views/users/audit_logs/attachments`。
- 打通最小可用 API：记录新增/查询（分页）/更新/删除；视图读取与更新；附件上传与扫描。
- 接入前端：将当前前端的增删改查与筛选调用后端 API，保留本地历史与服务端对齐。
- 实时与协作：基础变更推送与冲突处理（最后写入覆盖），后续可选编辑锁。
- 权限落地：字段级权限读取与写入校验；视图共享权限控制；导出权限设置。
- 导入导出：实现新表导入与视图导出流；类型校验与错误反馈。
- 公式与颜色规则：公式字段的后端解析与计算；视图颜色规则存取与渲染支持。
- 审计与保留：审计日志记录与清理任务（保留 120 天）。
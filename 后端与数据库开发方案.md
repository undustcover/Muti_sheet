# 后端与数据库开发方案

## 目标与范围
- 目标：将前端的数据存储、计算、筛选、分组、排序、导入导出与颜色规则等能力沉到后端，提供长期存储与标准化数据处理（CRUD、查询、聚合、审计、权限）。
- 范围：单租户系统（不做多租户隔离）；提供登录与管理员后台；支持字段级权限与视图共享的权限管理；接口版本化与统一错误返回。
- 开发原则：遇到不清楚的地方必须向用户澄清，禁止自行增加功能或更改既有需求。

## 技术栈与基础设施
- 后端：`Node.js` + `NestJS`（TypeScript）
- 数据库：`PostgreSQL`
- ORM：`Prisma`
- 缓存与队列：`Redis`（缓存、任务队列、发布订阅）
- 鉴权：`JWT` + `RBAC`
- 文档：`Swagger/OpenAPI`（自动生成与同步）
- 测试：`Jest`（单元与集成），`Playwright`（必要时做 API/E2E）
- 部署：`Docker`/`Docker Compose`，分环境（`dev/test/staging/prod`）

## 架构模块划分
- `tables-service`：表与字段管理
- `records-service`：行与单元格 CRUD、批量导入导出
- `query-service`：筛选/排序/分组/聚合/分页（DSL）
- `formula-service`：公式解析与计算（Excel 风格），增量重算与缓存
- `view-service`：视图状态（列可见性/顺序、筛选/排序/分组、颜色规则），共享与导出开关
- `audit-service`：审计与历史、快照与撤销/重做（视图作用域）
- `files-service`：附件上传与防病毒扫描（服务器文件系统，Windows Defender）
- `auth-service`：认证、授权、管理员后台（用户与角色）
- 实时协作：WebSocket/Socket.IO 推送表/视图/记录变更；乐观更新与回滚提示

## 数据模型摘要（PostgreSQL）
- `projects(id, name, created_at)`
- `tables(id, project_id, name, created_at, ...)`
- `fields(id, table_id, name, type, options_json, order, visible, permission_json)`
- `records(id, table_id, created_at, created_by)`
- `records_data(record_id, table_id, data_jsonb, updated_at, updated_by)`（JSONB 存储，按 `field_id` 为键）
- `views(id, table_id, name, owner_user_id, shared_roles[], config_jsonb)`
- `color_rules(id, table_id, config_jsonb)`
- `attachments(id, table_id, record_id, path, meta_jsonb, size, created_at)`
- `audit_logs(id, actor_user_id, table_id, record_id, action, payload_jsonb, created_at)`
- `users(id, username, password_hash, roles[])`

## 权限与共享策略
- 角色：`owner, admin, editor, viewer`（可扩展）。
- 字段默认：未显式配置时默认 `viewer=只读`、`editor=可写`；支持字段“隐藏不可见”和“只读可见”两种状态。
- 视图共享：支持按用户精确共享与匿名只读共享（需表级开启）；共享视图默认不可导出，表编辑者开启后方可导出。
- 字段级权限：`fields.permission_json` 定义 `readRoles[]/writeRoles[]/hideRoles[]/readUsers[]/writeUsers[]` 等，支持角色与用户覆盖。

## 日期与时区
- 存储：统一 `UTC`（`TIMESTAMP WITH TIME ZONE` 或统一标准化为 UTC）。
- 显示：`Asia/Shanghai (UTC+8)`，格式 `YYYY-MM-DD`。

## 查询 DSL 与本地化
- 过滤：`eq, neq, lt, gt, lte, gte, in, like, regex, between, exists`；`like/regex` 不区分大小写（`ILIKE`/`~*`）。
- 排序：多字段排序；中文排序/匹配按拼音（ICU Collation，如 `COLLATE "zh-u-co-pinyin"`；不支持时采用应用层回退策略）。
- 分组与聚合：与前端口径一致；空值分组显示为“空值”，聚合支持 `sum, avg, min, max, count`。
- 分页：`page/pageSize`，限制最大页大小。

## 导入/导出
- 导入：所有导入均创建新表；首行固定为表头；类型自动推断（仅文本/数字/日期，无法判断类型按文本导入）；事务写入。
- 导出：基于 `viewId` 的视图状态（筛选/排序/分组），按字段格式与颜色规则生成 Excel，流式下载。

## 附件与防病毒
- 存储：服务器本地文件系统；单附件 ≤ `20MB`，总容量 ≤ `50GB`。
- 防病毒：Windows Defender 扫描；失败即拒绝并删除并告警；记录审计。

## 审计与历史
- 审计：记录操作主体、前后值、来源（工具栏/快捷键/导入等），保留 `120` 天。
- 撤销/重做：以视图为作用域，不跨会话；前端本地历史即时响应，服务端做最终一致性记录。

## 并发与编辑锁
- 冲突策略：同单元格最后写入覆盖（Last-Write-Wins）。
- 单元格编辑锁（Redis）：默认 TTL `120s`；`EX/PX` 原子过期；心跳续期每 `1/3～1/2` 周期（如 `30s`），校验 `requestId/userId`。
- 解除与覆盖：主动解锁、TTL 到期被动释放、定时巡检残留锁强制清除；高权限用户可强制解锁并通知原持锁者；均记录审计。

## 接口规范与版本控制
- 统一前缀：`/api/v1/...`（后续演进 `/api/v2` 保持兼容）。
- 统一结构：`{ code, message, data, traceId }`；错误不泄露堆栈。
- 文档与 Mock：Swagger/OpenAPI 同步更新；必要时提供 Mock 响应以支持前端联调。

## 部署与环境
- 环境：`dev/test/staging/prod`；使用 `Docker Compose` 管理 `PostgreSQL/Redis/Server`。
- 编码：PostgreSQL 使用 `UTF-8`，客户端连接 `UTF-8`；（如改用 MySQL，需 `utf8mb4`）。
- 配置：环境变量（示例）：
  - `DATABASE_URL=postgres://user:pass@host:5432/dbname`
  - `REDIS_URL=redis://host:6379`
  - `JWT_SECRET=...`、`JWT_EXPIRES_IN=...`
  - `ATTACHMENTS_DIR=...`

## 测试策略
- 单元测试：Service/Utils 层（Jest）。
- 集成测试：DAO/Repository 与数据库交互（测试库/事务回滚）。
- E2E：核心 API 流程与权限校验（Nest E2E 测试）。
- 覆盖率：关键模块 ≥ `80%`。

## 代码与约定
- TypeScript 严格模式；DTO + `class-validator` 校验；不直接暴露 Entity。
- ESLint + Prettier；提交信息遵循 `Conventional Commits`；API 变更走版本策略。
- 迁移使用 `Prisma Migrate`；禁止手工生产环境执行裸 SQL。
- 日志：结构化日志（JSON），`traceId` 贯穿；敏感信息不入日志。

## 里程碑
- M1：初始化项目与数据库连接，基础模型与迁移。
- M2：记录 CRUD 与视图读写、附件上传与扫描。
- M3：查询 DSL 与聚合、中文拼音排序（含回退）。
- M4：字段权限与视图共享、导出权限开关。
- M5：审计日志、撤销/重做（视图作用域）、管理员后台仪表盘。
- M6：部署打包与文档收尾。

## 澄清与变更控制
- 所有不明确事项须先与用户澄清并形成书面结论；禁止自行扩展功能或更改需求。
- 需求变更需更新文档与 API 版本，并通知前端同步调整。
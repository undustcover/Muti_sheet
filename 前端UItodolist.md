# 前端 UI todolist

## 推进顺序
- 表头菜单与抽屉细化 → 条件引擎（筛选/填色） → 权限联动（保护视图） → 视觉细化 → 其他模块（收集表/仪表盘/文档/文件夹）

## 迭代 ToDo
- 迭代1：表头菜单与抽屉细化
  - [x] 新增 `HeaderMenu` 组件（表头右侧三角）已挂载；现已支持：`隐藏字段`、`冻结至此字段`、`升序/降序`（排序）
  - [ ] 将菜单状态与 `App.tsx` 的 `columnMeta` 关联（进行中：已关联列可见性与排序；标题/类型更新与删除约束待办）
  - [x] 实现“冻结至此字段”：维护 `freezeCount`，将前 N 列设置 `position: sticky; left` 并计算 left 累积宽度
  - [x] 为“隐藏字段”实现列可见性（不影响数据导出），已提供“显示已隐藏字段”入口
  - [ ] DoD：每列可打开菜单并执行上述动作（当前已覆盖：隐藏/冻结/排序；其余待补齐）；表格渲染与交互正常，无控制台/终端错误

- 迭代2：条件引擎（筛选/填色）
  - [ ] 定义条件模型 `Condition = { fieldId, operator, value, scope }` 与操作符集合（等于/包含/大于/小于/为空/不为空/介于等）
  - [ ] 新增 `ConditionBuilder` 组件（用于工具栏“筛选”“填色”入口），支持保存/取消
  - [ ] 基于条件对 `table` 数据进行筛选（优先链式组合 AND/OR 简版），与 `@tanstack/react-table` 排序互不冲突
  - [ ] 填色规则：根据 `scope`（单元格/整行/整列）返回样式类名并应用到渲染节点；用 `zustand` 建立 `ColorRulesStore`
  - [ ] DoD：添加/编辑/删除规则即时生效；筛选与填色在大数据量下表现顺畅（虚拟滚动无异常）

- 迭代3：权限联动（保护视图）
  - [ ] 在 `ProtectDrawer` 三种模式下：`locked` 禁用字段编辑与结构变更；`personal` 限制非所有者的视图可见性；`public` 正常编辑
  - [ ] 引入 `currentUser` 模拟上下文与视图拥有者；工具栏与表头菜单按模式禁用/隐藏相关动作
  - [ ] 添加锁定指示与只读提示（工具栏/表头旁）
  - [ ] DoD：切换模式后权限即时生效；非所有者在 `personal` 模式看不到该视图

- 迭代4：视觉细化（美观一致）
  - [ ] 引入设计令牌（CSS变量）：`--color-primary`、`--radius`、`--shadow`、`--spacing`、`--font` 等并应用到 `Sidebar/Tabs/Toolbar/Drawer`
  - [ ] 优化标签页外观（更圆润、层次阴影、激活态边框与背景、过渡动画），为菜单与弹窗加统一的阴影与动效
  - [ ] 统一按钮样式、输入框状态（hover/focus/disabled），对齐飞书风格基线
  - [ ] DoD：整页视觉一致、轻量动效自然、无布局抖动

- 迭代5：模块占位增强
  - [ ] 收集表：表单字段列表、发布链接占位、简单提交预览
  - [ ] 仪表盘：卡片栅格、折线/柱状/饼图占位（假数据）
  - [ ] 文档：富文本编辑器占位（只读/编辑切换）
  - [ ] 文件夹：文件列表与预览框占位
  - [ ] DoD：侧边栏切换各模块均有基础原型，页面无报错

## 每日 ToDo
- 启动与健康检查
  - [ ] 执行 `pnpm run dev`（目录 `apps/web`），打开 `http://localhost:5173/`
  - [ ] 浏览器控制台无错误；终端无新错误日志；HMR 正常
- 开发与自测
  - [ ] 当日计划任务清单（从“迭代 ToDo”中选定 2–4 个）
  - [ ] 每个任务完成即执行功能验收（交互/权限/视觉），记录异常与改进点
- 稳定性与回归
  - [ ] 快速脚本自测：添加/编辑/排序/切换视图/保护视图/导入导出
  - [ ] 预览确认：主路径（侧边栏→数据表→页签→工具栏→表格）不报错

## 验收清单
- [ ] 表头菜单功能全覆盖，首列规则与冻结列可用
- [ ] 条件引擎可构建 ≥3 种常用规则并正确筛选与填色
- [ ] 保护视图权限约束落地，UI有只读/锁定提示
- [ ] 视觉统一且无明显违和；交互动效轻量自然
- [ ] Excel 导入/导出在新 UI 下流程通畅
- [ ] `http://localhost:5173/` 无错误日志；终端运行正常

## 风险控制
- 复杂交互分步落地：先打通数据模型与状态，再接入视觉与动效，避免“大而全”一次性改动
- 明确约束：首列不可删除、冻结列与 sticky 边界处理、筛选与排序的组合优先级
- 性能保障：每次引入条件/填色均校验虚拟滚动帧率与渲染成本；避免在单元格内创建重型组件
- 迭代内不做跨域改动：专注于当前迭代目标，超范围需求进入下一迭代 Backlog

## 更新规则（新增）
- 不删减已有内容；仅新增进度与“进展更新/下一步工作”条目。
- 每次更新必须追加一个“进展更新（版本号+日期）”区块，并保持时间倒序。
- 仅在功能完全完成时，至《待办事项.md》将对应条目注释处理；本文件保留进度记录。
- 代码改动需在“进展更新”中明确文件路径与影响范围。

## 进展更新（v0.0.4｜2025-10-28）
- 完成：ColorRulesDrawer 支持规则“搜索过滤”（按列名与条件摘要），虚拟滚动绑定筛选后列表；新增搜索输入与匹配统计（文件：`apps/web/src/components/ColorRulesDrawer.tsx`）。
- E2E：`tests/e2e/color-rules.spec.ts` 增加过滤断言，并修复严格模式文本歧义与残留 diff 标记；一次回归中两条用例全部通过，目前存在加载时序偶发失败，后续引入 `data-app-ready` 标记与适当等待以增强稳定性。
- 预览确认：`http://localhost:5173/` 无浏览器错误，交互正常。
- 条件摘要：在规则项中显示条件概要文本（如“字段A > 100 且 字段B包含X”）。
- 行作用域条件入口：如需与“单元格”一致，仅在选择“整行”时显示筛选条件入口并应用行级匹配。
- 交互优化：为规则项提供悬停工具条（复制/删除/启用），提升列表操作一致性。
- 测试补充：为 `ColorRulesDrawer` 与 `colorRules.ts` 添加最小单测与1条E2E，覆盖复制/批量启用、条件应用与虚拟滚动渲染。
- 布局修复：移除模板居中与 `#root` 最大宽度，页面左侧额外空白消失，侧边栏与表格区域恢复满宽。
- 侧边栏高亮：新增 `activeProId` 状态，点击 Collect/Dashboard/Folder 时按条目ID单行高亮；创建/删除联动清理状态。
- 模块占位：收集表/仪表盘/文件夹条目创建/删除与高亮已可用；模块UI占位与功能完善后续推进。
- 预览与验证：`http://localhost:5173/` / `http://localhost:5174/` 无错误，布局稳定。

## 下一步工作（v0.0.4 对齐）
- HeaderMenu：补齐“编辑字段/编辑描述/整列填色/复制字段/插入左/右/删除字段”，完善 `columnMeta` 关联与约束。
- 条件引擎：搭建 `ConditionBuilder` 初版，先实现 `eq/contains/empty` 三类规则；与 ColorRules 联动。
- 测试与稳定性：为 `Sidebar/Tabs` 增补组件测试；E2E 加入 app-ready 等待与主路径稳定性校验。
- 布局修复：移除模板居中与 `#root` 最大宽度，确保侧边栏与表格区域满宽显示。
- 模块占位：为收集表/仪表盘/文档/文件夹添加页面占位与基础交互，保证侧边栏切换原型完整。